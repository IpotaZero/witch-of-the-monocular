class b{static container;static init(){this.container=document.getElementById("container")}}const A="modulepreload",S=function(r,t){return new URL(r,t).href},g={},k=function(t,e,s){let i=Promise.resolve();if(e&&e.length>0){let w=function(o){return Promise.all(o.map(d=>Promise.resolve(d).then(y=>({status:"fulfilled",value:y}),y=>({status:"rejected",reason:y}))))};const n=document.getElementsByTagName("link"),l=document.querySelector("meta[property=csp-nonce]"),f=l?.nonce||l?.getAttribute("nonce");i=w(e.map(o=>{if(o=S(o,s),o in g)return;g[o]=!0;const d=o.endsWith(".css"),y=d?'[rel="stylesheet"]':"";if(!!s)for(let p=n.length-1;p>=0;p--){const v=n[p];if(v.href===o&&(!d||v.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${o}"]${y}`))return;const h=document.createElement("link");if(h.rel=d?"stylesheet":A,d||(h.as="script"),h.crossOrigin="",h.href=o,f&&h.setAttribute("nonce",f),document.head.appendChild(h),d)return new Promise((p,v)=>{h.addEventListener("load",p),h.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${o}`)))})}))}function a(n){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=n,window.dispatchEvent(l),!l.defaultPrevented)throw n}return i.then(n=>{for(const l of n||[])l.status==="rejected"&&a(l.reason);return t().catch(a)})};class c{static async fade(t,e=200){await this.fadeOut(t,e),this.fadeIn(t,e)}static async fadeOut(t,e=200){t.style.transition="opacity 0s",t.style.pointerEvents="none",[...t.children].forEach(s=>s.style.pointerEvents="none"),await this.frame(()=>{t.style.opacity="1"}),await this.frame(()=>{t.style.transition=`opacity ${e}ms`}),await this.frame(()=>{t.style.opacity="0",t.style.pointerEvents="none"}),await this.sleep(e)}static async fadeIn(t,e=200){t.style.transition="opacity 0s",t.style.pointerEvents="none",[...t.children].forEach(s=>s.style.pointerEvents="none"),await this.frame(()=>{t.style.opacity="0"}),await this.frame(()=>{t.style.transition=`opacity ${e}ms`}),await this.frame(()=>{t.style.opacity="1",t.style.pointerEvents="",[...t.children].forEach(s=>s.style.pointerEvents="")}),await this.sleep(e)}static sleep(t){return new Promise(e=>{setTimeout(e,t)})}static ok(){const t=new AbortController;return new Promise(e=>{document.addEventListener("click",()=>{t.abort(),e()},{signal:t.signal}),document.addEventListener("keydown",s=>{["KeyZ","Enter","Space"].includes(s.code)&&(t.abort(),e())},{signal:t.signal})})}static key(){const t=new AbortController;return new Promise(e=>{document.addEventListener("click",()=>{t.abort(),e()},{signal:t.signal}),document.addEventListener("keydown",s=>{t.abort(),e()},{signal:t.signal})})}static frame(t=()=>{}){return new Promise(e=>requestAnimationFrame(()=>{t(),e()}))}static async enter(t,e){t.style.transition="opacity 0s, scale 0s",t.style.pointerEvents="none",await this.frame(()=>{t.style.opacity="0",t.style.scale="0"}),await this.frame(()=>{t.style.transition=`opacity ${e}ms, scale ${e}ms`}),await this.frame(()=>{t.style.opacity="1",t.style.scale="",t.style.pointerEvents=""}),await this.sleep(e),this.frame(),t.style.pointerEvents="all"}static async enterReverse(t,e){t.style.transition="opacity 0s, scale 0s",t.style.pointerEvents="none",await this.frame(()=>{t.style.opacity="1",t.style.scale="1"}),await this.frame(()=>{t.style.transition=`opacity ${e}ms, scale ${e}ms`}),await this.frame(()=>{t.style.opacity="0",t.style.scale="0",t.style.pointerEvents=""}),await this.sleep(e),this.frame(),t.style.pointerEvents="all"}static async exit(t,e){t.style.transition="opacity 0s, scale 0s",t.style.pointerEvents="none",await this.frame(()=>{t.style.opacity="1",t.style.scale="1"}),await this.frame(()=>{t.style.transition=`opacity ${e}ms, scale ${e}ms`}),await this.frame(()=>{t.style.opacity="0",t.style.scale="3",t.style.pointerEvents=""}),await this.sleep(e),this.frame(),t.style.pointerEvents="all"}static async exitReverse(t,e){t.style.transition="opacity 0s, scale 0s",t.style.pointerEvents="none",await this.frame(()=>{t.style.opacity="0",t.style.scale="3"}),await this.frame(()=>{t.style.transition=`opacity ${e}ms, scale ${e}ms`}),await this.frame(()=>{t.style.opacity="1",t.style.scale="",t.style.pointerEvents=""}),await this.sleep(e),this.frame(),t.style.pointerEvents="all"}}class P{defaultMSIn=700;defaultMSOut=700;pages=new E({});#t=new E({});#e=new E({});#i=new E({});#a;#s=[];#n="絶対に存在しないページID";async load(t,e,{history:s}={}){this.#a=t,this.#a.innerHTML=e;const i=s&&s.length?s.at(-1):"first";this.#s=s&&s.length?s.slice(0,-1):[],Array.from(t.querySelectorAll(".page")).forEach(a=>{this.pages.add(a.id,a),a.id!==i&&a.classList.add("hidden")}),await this.goto(i,{msIn:0,msOut:0}),this.updateButtons()}shaveBranch(t){this.#s=this.#s.slice(0,-t)}getCurrentBranch(){return[...this.#s]}on(t,e){this.#t.add(t,e)}onLeft(t,e){this.#e.add(t,e)}before(t,e){this.#i.add(t,e)}onSubmit(t,e){const s=this.pages.get(t);if(!s)throw new Error("そんなページはない");const i=s.querySelector("form"),a=s.querySelector("input");if(!i||!a)throw new Error("そんなformはない");i.onsubmit=n=>{n.preventDefault(),e(a.value)}}updateButtons(){Array.from(this.#a.querySelectorAll("button")).filter(t=>!t.classList.contains("non-page")).forEach((t,e)=>{let s;t.hasAttribute("data-ms-in")&&(s=Number(t.getAttribute("data-ms-in"))),t.onclick=()=>{this.goto(t.dataset.link,{msIn:s,back:t.classList.contains("back")})};const i=t.getAttribute("data-back");i&&(t.onclick=()=>{this.back(Number(i),{msIn:s})})})}async back(t,{msIn:e,msOut:s}={}){for(let i=0;i<t;i++)this.#l({msIn:e,msOut:s,back:!0})}#l(t){this.#s.length<=0||(this.#s.pop(),this.goto(this.#s.pop(),t))}async goto(t,{msIn:e=this.defaultMSIn,msOut:s=this.defaultMSOut,back:i=!1}={}){if(await this.#c(t))return;this.#u(),await this.#h(this.#n);const a=this.pages.get(this.#n),n=this.pages.get(t);this.#n=t,this.#s.push(t),await this.#o(e,a,n,i),this.#d(this.#n)}async#o(t,e,s,i){if(s?.classList.remove("hidden"),t>0){const a=Number(e?.getAttribute("data-layer"))||0,n=Number(s?.getAttribute("data-layer"))||0;a<=n&&this.#r(s,i,t,!0),a>=n&&this.#r(e,i,t,!1),await c.sleep(t),a>=n&&e?.classList.add("hidden")}}#r(t,e,s,i){i?e?t&&c.exitReverse(t,s):t&&c.enter(t,s):e?t&&c.enterReverse(t,s):t&&c.exit(t,s)}async#c(t){const e=this.#i.getAll(t).map(i=>i(this)).toArray();return(await Promise.all(e)).some(Boolean)}#h(t){return Promise.all(this.#e.getAll(t).map(e=>e(this)))}#d(t){requestAnimationFrame(()=>{this.#t.getAll(t).forEach(e=>e(this)),this.#f()})}#u(){this.#a.style.pointerEvents="none",this.pages.getValues().forEach(t=>t.style.pointerEvents="none"),this.pages.getValues().forEach(t=>t.querySelectorAll("button").forEach(e=>e.disabled=!0))}#f(){this.pages.getValues().filter(t=>!t.classList.contains("hidden")).forEach(t=>t.querySelectorAll("button").forEach(e=>e.disabled=!1)),this.#a.style.pointerEvents="",this.pages.getValues().forEach(t=>t.style.pointerEvents="")}}class E{#t;constructor(t){this.#t=t}get(t){for(const[e,s]of Object.entries(this.#t))if(new RegExp(`^${e}$`).test(t))return s}*getAll(t){for(const[e,s]of Object.entries(this.#t))new RegExp(`^${e}$`).test(t)&&(yield s)}getKeys(){return Object.keys(this.#t)}getValues(){return Object.values(this.#t)}add(t,e){this.#t[t]=e}}class ${async end(){}}class L{static#t;static init(t){this.#t=t}static async goto(t,{showLoading:e=this.#a,hideLoading:s=this.#s,msIn:i=800,msOut:a=800,mode:n="scale"}={}){const l=document.getElementById("container");await this.#e(l,i,n),await this.#t.end();let f=!1,w=!1;c.sleep(1e3).then(()=>{f||(e(),w=!0)}),this.#t=t(),await this.#t.ready,f=!0,w&&s(),await this.#i(l,a,n)}static async#e(t,e,s){e>0&&(s==="scale"?await c.exit(t,e):s==="fade"&&await c.fadeOut(t,e))}static async#i(t,e,s){e>0&&(s==="scale"?await c.enter(t,e):s==="fade"&&await c.fadeIn(t,e))}static#a(){const t=document.createElement("p");t.textContent="Loading...",t.classList.add("loading"),document.body.appendChild(t)}static#s(){document.querySelectorAll(".loading").forEach(t=>t.remove())}}class x extends ${ready;#t=new P;constructor(){super(),this.ready=this.#e()}async#e(){const t=await(await fetch("pages/pretitle.html")).text();await this.#t.load(b.container,t),this.#i()}async#i(){await c.ok();const{SceneTitle:t}=await k(async()=>{const{SceneTitle:e}=await import("./assets/SceneTitle-Dap_pqzb.js").then(s=>s.S);return{SceneTitle:e}},[],import.meta.url);await L.goto(()=>new t,{mode:"fade",msOut:1e3})}}class u{#t;constructor(t,e=.5){this.#t=new Audio(t),this.#t.volume=e}get duration(){return this.#t.duration}play(){this.#t.currentTime=0,this.#t.play()}setVolume(t){this.#t.volume=t}}class m{static voice=new u("assets/sounds/voice.wav");static what=new u("assets/sounds/what.wav");static surprised=new u("assets/sounds/surprised.wav");static strong=new u("assets/sounds/strong.wav");static say=new u("assets/sounds/say.mp3");static clear=new u("assets/sounds/clear.mp3",1);static setVolume(t){Object.values(this).forEach(e=>{e.setVolume(t)})}}class O{static#t;static#e;static#i=[];static#a=()=>{};static wait(){return new Promise(t=>{this.#a=t})}static init(){this.#t=document.createElement("div"),this.#t.id="serif-container",this.#t.classList.add("hidden"),this.#e=document.createElement("div"),this.#e.id="serif",this.#e.classList.add("fade-in","hidden"),this.#t.onclick=()=>{this.#s()},window.addEventListener("keydown",t=>{["KeyZ","Enter","Space"].includes(t.code)&&this.#s()}),this.#t.appendChild(this.#e),document.body.appendChild(this.#t)}static hide(){this.#t.classList.add("hidden")}static show(){this.#t.classList.remove("hidden"),this.#e.classList.add("hidden")}static say(...t){this.#i=t,this.#s(),this.show()}static#s(){if(this.#i.length===0)this.#t.classList.add("hidden"),this.#a();else{this.#e.classList.remove("fade-in");const t=this.#i.shift()+"";t.endsWith(")")?(this.#e.innerHTML="",m.say.play()):this.#e.innerHTML='<img src="assets/images/icon.png" align="top" />',t.endsWith(")")||(t.endsWith("!")?m.strong.play():t.endsWith("!?")?m.surprised.play():t.endsWith("?")?m.what.play():m.voice.play()),requestAnimationFrame(()=>{this.#e.innerHTML+=`<div class="text-area text-end">${t}</div>`,this.#e.classList.add("fade-in"),this.#e.classList.remove("hidden")})}}}class C{static#t;static#e;static init(){this.#t=document.createElement("div"),this.#t.id="serif-container",this.#t.classList.add("hidden"),this.#e=document.createElement("div"),this.#e.id="ask",this.#e.classList.add("fade-in"),this.#t.appendChild(this.#e),document.body.appendChild(this.#t)}static hide(){this.#t.classList.add("hidden")}static show(){this.#t.classList.remove("hidden")}static ask(t){this.show(),this.#e.innerHTML="";const e=t.map(s=>{const i=document.createElement("button");return i.textContent=s,i.classList.add("question-button"),this.#e.appendChild(i),i});return new Promise(s=>{e.forEach((i,a)=>{i.onclick=()=>{s(t[a]),this.hide()}})})}}C.init();O.init();b.init();document.addEventListener("DOMContentLoaded",()=>{L.init(new x)});window.addEventListener("contextmenu",r=>{r.preventDefault()});export{C as A,b as D,P,$ as S,k as _,O as a,L as b,m as c,c as d};
//# sourceMappingURL=run.js.map
