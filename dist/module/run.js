class L{static container;static init(){this.container=document.getElementById("container")}}const A="modulepreload",k=function(r,t){return new URL(r,t).href},b={},P=function(t,e,s){let i=Promise.resolve();if(e&&e.length>0){let g=function(c){return Promise.all(c.map(u=>Promise.resolve(u).then(y=>({status:"fulfilled",value:y}),y=>({status:"rejected",reason:y}))))};const n=document.getElementsByTagName("link"),l=document.querySelector("meta[property=csp-nonce]"),f=l?.nonce||l?.getAttribute("nonce");i=g(e.map(c=>{if(c=k(c,s),c in b)return;b[c]=!0;const u=c.endsWith(".css"),y=u?'[rel="stylesheet"]':"";if(!!s)for(let p=n.length-1;p>=0;p--){const v=n[p];if(v.href===c&&(!u||v.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${c}"]${y}`))return;const d=document.createElement("link");if(d.rel=u?"stylesheet":A,u||(d.as="script"),d.crossOrigin="",d.href=c,f&&d.setAttribute("nonce",f),document.head.appendChild(d),u)return new Promise((p,v)=>{d.addEventListener("load",p),d.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${c}`)))})}))}function a(n){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=n,window.dispatchEvent(l),!l.defaultPrevented)throw n}return i.then(n=>{for(const l of n||[])l.status==="rejected"&&a(l.reason);return t().catch(a)})};class o{static async fade(t,e=200){await this.fadeOut(t,e),this.fadeIn(t,e)}static async fadeOut(t,e=200){t.style.transition="opacity 0s",t.style.pointerEvents="none",[...t.children].forEach(s=>s.style.pointerEvents="none"),await this.frame(()=>{t.style.opacity="1"}),await this.frame(()=>{t.style.transition=`opacity ${e}ms`}),await this.frame(()=>{t.style.opacity="0",t.style.pointerEvents="none"}),await this.sleep(e)}static async fadeIn(t,e=200){t.style.transition="opacity 0s",t.style.pointerEvents="none",[...t.children].forEach(s=>s.style.pointerEvents="none"),await this.frame(()=>{t.style.opacity="0"}),await this.frame(()=>{t.style.transition=`opacity ${e}ms`}),await this.frame(()=>{t.style.opacity="1",t.style.pointerEvents="",[...t.children].forEach(s=>s.style.pointerEvents="")}),await this.sleep(e)}static sleep(t){return new Promise(e=>{setTimeout(e,t)})}static ok(){const t=new AbortController;return new Promise(e=>{document.addEventListener("click",()=>{t.abort(),e()},{signal:t.signal}),document.addEventListener("keydown",s=>{["KeyZ","Enter","Space"].includes(s.code)&&(t.abort(),e())},{signal:t.signal})})}static key(){const t=new AbortController;return new Promise(e=>{document.addEventListener("click",()=>{t.abort(),e()},{signal:t.signal}),document.addEventListener("keydown",s=>{t.abort(),e()},{signal:t.signal})})}static frame(t=()=>{}){return new Promise(e=>requestAnimationFrame(()=>{t(),e()}))}static async enter(t,e){t.style.transition="opacity 0s, scale 0s",t.style.pointerEvents="none",await this.frame(()=>{t.style.opacity="0",t.style.scale="0"}),await this.frame(()=>{t.style.transition=`opacity ${e}ms, scale ${e}ms`}),await this.frame(()=>{t.style.opacity="1",t.style.scale="",t.style.pointerEvents=""}),await this.sleep(e),this.frame(),t.style.pointerEvents="all"}static async enterReverse(t,e){t.style.transition="opacity 0s, scale 0s",t.style.pointerEvents="none",await this.frame(()=>{t.style.opacity="1",t.style.scale="1"}),await this.frame(()=>{t.style.transition=`opacity ${e}ms, scale ${e}ms`}),await this.frame(()=>{t.style.opacity="0",t.style.scale="0",t.style.pointerEvents=""}),await this.sleep(e),this.frame(),t.style.pointerEvents="all"}static async exit(t,e){t.style.transition="opacity 0s, scale 0s",t.style.pointerEvents="none",await this.frame(()=>{t.style.opacity="1",t.style.scale="1"}),await this.frame(()=>{t.style.transition=`opacity ${e}ms, scale ${e}ms`}),await this.frame(()=>{t.style.opacity="0",t.style.scale="3",t.style.pointerEvents=""}),await this.sleep(e),this.frame(),t.style.pointerEvents="all"}static async exitReverse(t,e){t.style.transition="opacity 0s, scale 0s",t.style.pointerEvents="none",await this.frame(()=>{t.style.opacity="0",t.style.scale="3"}),await this.frame(()=>{t.style.transition=`opacity ${e}ms, scale ${e}ms`}),await this.frame(()=>{t.style.opacity="1",t.style.scale="",t.style.pointerEvents=""}),await this.sleep(e),this.frame(),t.style.pointerEvents="all"}}class T{defaultMSIn=700;defaultMSOut=700;pages=new E({});#t=new E({});#e=new E({});#i=new E({});#a;#s=[];#r="絶対に存在しないページID";async load(t,e,{history:s}={}){this.#a=t,this.#a.innerHTML=e;const i=s&&s.length?s.at(-1):"first";this.#s=s&&s.length?s.slice(0,-1):[],Array.from(t.querySelectorAll(".page")).forEach(a=>{this.pages.add(a.id,a),a.id!==i&&a.classList.add("hidden")}),await this.goto(i,{msIn:0,msOut:0}),this.updateButtons()}shaveBranch(t){this.#s=this.#s.slice(0,-t)}getCurrentBranch(){return[...this.#s]}on(t,e){this.#t.add(t,e)}onLeft(t,e){this.#e.add(t,e)}before(t,e){this.#i.add(t,e)}onSubmit(t,e){const s=this.pages.get(t);if(!s)throw new Error("そんなページはない");const i=s.querySelector("form"),a=s.querySelector("input");if(!i||!a)throw new Error("そんなformはない");i.onsubmit=n=>{n.preventDefault(),e(a.value)}}updateButtons(){Array.from(this.#a.querySelectorAll("button")).filter(t=>!t.classList.contains("non-page")).forEach((t,e)=>{let s;t.hasAttribute("data-ms-in")&&(s=Number(t.getAttribute("data-ms-in"))),t.onclick=()=>{this.goto(t.dataset.link,{msIn:s,back:t.classList.contains("back")})};const i=t.getAttribute("data-back");i&&(t.onclick=()=>{this.back(Number(i),{msIn:s})})})}async back(t,{msIn:e,msOut:s}={}){for(let i=0;i<t;i++)this.#l({msIn:e,msOut:s,back:!0})}#l(t){this.#s.length<=0||(this.#s.pop(),this.goto(this.#s.pop(),t))}async goto(t,{msIn:e=this.defaultMSIn,msOut:s=this.defaultMSOut,back:i=!1}={}){if(await this.#o(t))return;this.#u(),await this.#h(this.#r);const a=this.pages.get(this.#r),n=this.pages.get(t);this.#r=t,this.#s.push(t),await this.#c(e,a,n,i),this.#d(this.#r)}async#c(t,e,s,i){if(s?.classList.remove("hidden"),t>0){const a=Number(e?.getAttribute("data-layer"))||0,n=Number(s?.getAttribute("data-layer"))||0;a<=n&&this.#n(s,i,t,!0),a>=n&&this.#n(e,i,t,!1),await o.sleep(t),a>=n&&e?.classList.add("hidden")}}#n(t,e,s,i){i?e?t&&o.exitReverse(t,s):t&&o.enter(t,s):e?t&&o.enterReverse(t,s):t&&o.exit(t,s)}async#o(t){const e=this.#i.getAll(t).map(i=>i(this)).toArray();return(await Promise.all(e)).some(Boolean)}#h(t){return Promise.all(this.#e.getAll(t).map(e=>e(this)))}#d(t){requestAnimationFrame(()=>{this.#t.getAll(t).forEach(e=>e(this)),this.#f()})}#u(){this.#a.style.pointerEvents="none",this.pages.getValues().forEach(t=>t.style.pointerEvents="none"),this.pages.getValues().forEach(t=>t.querySelectorAll("button").forEach(e=>e.disabled=!0))}#f(){this.pages.getValues().filter(t=>!t.classList.contains("hidden")).forEach(t=>t.querySelectorAll("button").forEach(e=>e.disabled=!1)),this.#a.style.pointerEvents="",this.pages.getValues().forEach(t=>t.style.pointerEvents="")}}class E{#t;constructor(t){this.#t=t}get(t){for(const[e,s]of Object.entries(this.#t))if(new RegExp(`^${e}$`).test(t))return s}*getAll(t){for(const[e,s]of Object.entries(this.#t))new RegExp(`^${e}$`).test(t)&&(yield s)}getKeys(){return Object.keys(this.#t)}getValues(){return Object.values(this.#t)}add(t,e){this.#t[t]=e}}class ${async end(){}}class S{static#t;static init(t){this.#t=t}static async goto(t,{showLoading:e=this.#a,hideLoading:s=this.#s,msIn:i=800,msOut:a=800,mode:n="scale"}={}){const l=document.getElementById("container");await this.#e(l,i,n),await this.#t.end();let f=!1,g=!1;o.sleep(1e3).then(()=>{f||(e(),g=!0)}),this.#t=t(),await this.#t.ready,f=!0,g&&s(),await this.#i(l,a,n)}static async#e(t,e,s){e>0&&(s==="scale"?await o.exit(t,e):s==="fade"&&await o.fadeOut(t,e))}static async#i(t,e,s){e>0&&(s==="scale"?await o.enter(t,e):s==="fade"&&await o.fadeIn(t,e))}static#a(){const t=document.createElement("p");t.textContent="Loading...",t.classList.add("loading"),document.body.appendChild(t)}static#s(){document.querySelectorAll(".loading").forEach(t=>t.remove())}}class x extends ${ready;#t=new T;constructor(){super(),this.ready=this.#e()}async#e(){const t=await(await fetch("pages/pretitle.html")).text();await this.#t.load(L.container,t),this.#i()}async#i(){await o.ok();const{SceneTitle:t}=await P(async()=>{const{SceneTitle:e}=await import("./assets/SceneTitle-D8sfcIEl.js").then(s=>s.S);return{SceneTitle:e}},[],import.meta.url);await S.goto(()=>new t)}}class h{static#t;static#e;static#i=1;static#a=!1;static#s=null;#r;#l;#c;#n=null;#o=!1;constructor(t,e={}){this.#r=t,this.#l=h.#t.createGain(),this.#l.connect(h.#e),this.#c=this.#h(e)}async#h(t){const s=await(await fetch(this.#r)).arrayBuffer(),i=await h.#t.decodeAudioData(s);this.#n=h.#t.createBufferSource(),this.#n.buffer=i,this.#n.loopStart=t.loopStartS??0,this.#n.loopEnd=t.loopEndS??i.duration,this.#n.loop=!0,this.#n.connect(this.#l)}async#d(t){this.#l.gain.cancelScheduledValues(h.#t.currentTime),this.#l.gain.linearRampToValueAtTime(0,h.#t.currentTime+t/1e3),await new Promise(e=>setTimeout(e,t)),this.#o&&this.#n?.stop(),this.#n?.disconnect()}static init(){if(this.#a)throw new Error("すでにinitialized!");this.#a=!0,this.#t=new AudioContext,this.#e=this.#t.createGain(),this.#e.connect(this.#t.destination)}static getPath(){return this.#s?this.#s.#r:""}static async ffp(t,e={}){await Promise.all([this.#y(1e3),this.#u(t,e)]),this.getPath()===t&&this.#f(e.when)}static async#u(t,e){this.#s=new h(t,e),await this.#s.#c}static#f(t){this.#s&&(this.#s.#n?.start(this.#t.currentTime+(t??0)),this.#s.#o=!0)}static setVolume(t){this.#i=t,this.#e.gain.cancelScheduledValues(this.#t.currentTime),this.#e.gain.value=this.#i}static#y(t){if(this.#s)return this.#s.#d(t),new Promise(e=>setTimeout(e,t))}static async fade(t,e){this.#e.gain.cancelScheduledValues(this.#t.currentTime),this.#e.gain.setValueAtTime(this.#i,this.#t.currentTime),this.#e.gain.linearRampToValueAtTime(t,this.#t.currentTime+e/1e3),await new Promise(s=>setTimeout(s,e))}}window.BGM=h;class m{#t;constructor(t,e=.5){this.#t=new Audio(t),this.#t.volume=e}get duration(){return this.#t.duration}play(){this.#t.currentTime=0,this.#t.play()}setVolume(t){this.#t.volume=t}}class w{static voice=new m("assets/sounds/voice.wav");static what=new m("assets/sounds/what.wav");static surprised=new m("assets/sounds/surprised.wav");static strong=new m("assets/sounds/strong.wav");static say=new m("assets/sounds/say.mp3");static setVolume(t){Object.values(this).forEach(e=>{e.setVolume(t)})}}class O{static#t;static#e;static#i=[];static#a=()=>{};static wait(){return new Promise(t=>{this.#a=t})}static init(){this.#t=document.createElement("div"),this.#t.id="serif-container",this.#t.classList.add("hidden"),this.#e=document.createElement("div"),this.#e.id="serif",this.#e.classList.add("fade-in","hidden"),this.#t.onclick=()=>{this.#s()},window.addEventListener("keydown",t=>{["KeyZ","Enter","Space"].includes(t.code)&&this.#s()}),this.#t.appendChild(this.#e),document.body.appendChild(this.#t)}static hide(){this.#t.classList.add("hidden")}static show(){this.#t.classList.remove("hidden"),this.#e.classList.add("hidden")}static say(...t){this.#i=t,this.#s(),this.show()}static#s(){if(this.#i.length===0)this.#t.classList.add("hidden"),this.#a();else{this.#e.classList.remove("fade-in");const t=this.#i.shift()+"";t.endsWith(")")?(this.#e.innerHTML="",w.say.play()):this.#e.innerHTML='<img src="assets/images/icon.png" align="top" />',t.endsWith(")")||(t.endsWith("!")?w.strong.play():t.endsWith("!?")?w.surprised.play():t.endsWith("?")?w.what.play():w.voice.play()),requestAnimationFrame(()=>{this.#e.innerHTML+=`<div class="text-area text-end">${t}</div>`,this.#e.classList.add("fade-in"),this.#e.classList.remove("hidden")})}}}h.init();O.init();L.init();document.addEventListener("DOMContentLoaded",()=>{S.init(new x)});window.addEventListener("contextmenu",r=>{r.preventDefault()});export{o as A,h as B,L as D,T as P,$ as S,P as _,S as a,w as b,O as c};
//# sourceMappingURL=run.js.map
